产品需求文档 (PRD): BiliQueue - B 站单标签页增强队列 (最终版)
版本： V1.4 (Zero-Friction & Minimum-Resistance Edition) 状态： 最终交付版 日期： 2024-05-24
1. 产品定义与目标
1.1 产品愿景
在 Bilibili 实现极致顺滑的临时播放体验。通过“单标签页隔离”和“无询问式交互”，消除用户在“发现内容”与“连续消费”之间的所有操作阻力。
1.2 核心设计哲学：最小阻力原则
- 不要问，直接做：严禁弹出任何确认对话框（如“是否清空队列”、“是否添加”）。
- 无感接管：一旦用户开始使用队列，插件即自动处理后续逻辑，无需用户干预。
- 情境隔离：数据随 Tab 产生，随 Tab 消失。
2. 用户交互流 (The Zero-Friction Flow)
2.1 队列启动与创建
- 初始状态：页面无队列 UI，保持 B 站原生纯净感。
- 激活触发：用户点击任何视频卡片上的“+”按钮，或右键选择“加入队列”。
- 结果：
  1. 队列面板立即在右下角静默弹出。
  2. 视频加入列表。
  3. 无询问，不打断当前浏览行为。
2.2 手动点击跳转 (Silent Insert & Pivot)
- 场景：当当前标签页已存在队列时，用户直接点击一个视频进入播放页。
- 逻辑：
  - 自动识别意图：用户点击新视频，意味着他想“现在就看这个”。
  - 静默处理：将该视频自动插入到当前播放索引（currentIndex）的下一个位置。
  - 自动流转：跳转后，播放完该视频会自动顺延播放队列中原本的后续视频。
- 优势：无需询问“是否清看队列”，直接保留上下文并响应即时需求。
2.3 采集入口
- 封面悬浮按钮：鼠标划过视频封面，在原生“稍后再看”图标附近显示“+”图标。
- 右键快捷项：右键点击链接即加入，无需二次确认。
3. 功能详细需求
3.1 队列管理面板 (Minimalist UI)
- 视觉表现：采用 B 站原生设计语言（毛玻璃效果、深色模式适配）。
- 列表行为：
  - 自动高亮：正在播的视频始终处于列表视觉中心。
  - 移除即消失：点击移除按钮立即从 Session 中删除，无需确认。
  - 排序即生效：拖拽释放后立即更新后续播放顺序。
3.2 播放调度逻辑
- 强力接管：当视频结束时，插件直接修改 location.href 或调用 B 站播放器接口跳转，屏蔽 B 站原生的“推荐连播”倒计时。
- 多 P 处理：若视频有多个分 P，默认播完当前 P 后检查队列。如果队列有下一个视频，则跳走；若队列已空，则允许 B 站播放下一 P。
4. 技术实现与隔离逻辑
4.1 存储机制 (chrome.storage.session)
- 隔离 ID：queue_data_${tabId}。
- 自动清理：标签页关闭，Session 自动回收，零持久化负担。
4.2 路由监控
- URL 变化感知：Content Script 需监听 URL 变化。如果发现 URL 变成了视频页且不在队列中，则执行“静默插队”逻辑。
5. 异常与边缘处理
- 重复添加：若视频已在队列中，再次点击“添加”或“直接点击跳转”，则将该视频移动到目标位置（末尾或 currentIndex+1），而不是增加重复项。
- 网络断开/视频失效：若加载失败，3 秒后自动尝试队列下一个，不弹出错误弹窗卡住流程。
6. UI/UX 体验细节
- Toast 提示：仅在添加成功时在屏幕中央上方显示 1 秒的微型 Toast（如“已加入队列”），不遮挡视线。
- 迷你化状态：面板支持点击最小化为一个圆点，仅显示剩余视频数。
7. 开发者备注 (Implementation Priority)
1. 核心：实现基于 tabId 的 chrome.storage.session 读写。
2. 重点：实现 video.onended 的稳定拦截。
3. 难点：B 站复杂多变的瀑布流 DOM 结构下的按钮精准注入。
